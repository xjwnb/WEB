# 网络请求与远程资源

## XMLHttpRequest 对象

通过 XMLHttpRequest 构造函数原生支持 XHR 对象

```javascript
let xhr = new XMLHttpRequest();
```

### 使用 XHR

使用 XHR 对象首先要调用 `open()` 方法，这个方法接收 3 个参数：请求类型、请求URL、请求是否异步的布尔值。

```javascript
xhr.open("get", "example.php", false);
```

**注意：** 只能访问同源 URL，否则会抛出安全错误。

发送定义好的请求，必须调用 `send()` 方法：

`send()` 方法接收一个参数，是作为请求体发送的数据。如果不需要发送数据，就必须传入 null。

```javascript
xhr.open("get", "example.php", false);
xhr.send(null);
```

收到响应之后， XHR 对象的属性会被填充上数据。

- responseText：作为响应体返回的文本。
- responseXML：如果响应的内容类型是 "text/html" 或 "application/xml"，那就是包含响应数据的 XML DOM 文档。
- status：响应的 HTTP 状态。
- statusText：响应的 HTTP 状态描述。

XMR 对象又有一个 readyState 属性，表示当前处在请求/响应过程的那个阶段。属性的值：

- 0：未初始化。尚未调用 `open()` 方法。
- 1：已打开。已调用 `open()` 方法，尚未调用 `send()` 方法。
- 2：已发送。已调用 `send()` 方法，尚未收到响应。
- 3：接收中。已经收到部分响应。
- 4：完成。已经收到所有响应。

```javascript
let xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readystate == 4) {
        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
            console.log(xhr.responseText);
        } else {
            console.log("unsuccessful", xhr.status);
        }
    }
};
xhr.open("get", "example.php", true);
xhr.send(null);
```

在收到响应之前如果想取消异步请求，可以调用 `abort()` 方法。

### HTTP 头部

默认下，XHR 请求会发送以下头部字段

- Acceopt：浏览器可以处理的内容类型。
- Accept-Charset：浏览器可以显示的字符集。
- Accept-Encoding；浏览器可以处理的压缩编码类型。
- Accept-Language：浏览器使用的语言。
- Connection：浏览器与服务器的连接类型。
- Cookie：页面中设置的 Cookie。
- Host：发送请求的页面所在的域。
- Referer：发送请求的页面的 URI。
- User-Agent：浏览器的用户代理字符串。

如果需要发送额外的请求头部。可以使用 `setRequestHeader()` 方法。接收两个参数：头部字段的名称和值。必须放在 `open()` 之后，`send()` 方法之前。

可以使用 `getResponseHeader()` 方法从 XHR 对象获取响应头部。传入获取头部的名称即可。

获得所有响应头部，可以使用 `getAllResponseHeaders()` 方法。

### GET 请求

需要在 GET 请求的 URL 后面添加查询字符串参数。查询字符串必须正确编码后添加到 URL 后面，再传入 `open()` 方法。查询字符串中的每个名和值都必须使用 `encodeURIComponent()` 编码，所有名/值对必须以 "&" 分隔。

```javascript
xhr.open("get", "example.php?name=xkc&age=20", true);
```

URL 添加查询字符串的方法：

```javascript
function addURLParam(url, name, value) {
    url += url.indexOf("?") === -1: "?" : "&";
    url += encodeURIComponent(name) + "=" + encodeURIComponent(value);
    return url;
}
```

